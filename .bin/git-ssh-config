#!/bin/bash

NAMESPACE="";

if [[ $# -lt 1 ]]
then
	echo "Usage: git ssh-config <namespace>";
	exit 1;
fi

NAMESPACE=".${1}";

find ~/.ssh ~/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys -name '*.pub' 2>/dev/null | grep . &>/dev/null;
if [[ $? -ne 0 ]]
then
	echo "No SSH keys found!"
	exit
fi

echo "Pick a file to use for git-ssh identity:";

select PUBKEY in $(find ~/.ssh ~/Library/Containers/com.maxgoedjen.Secretive.SecretAgent/Data/PublicKeys -name '*.pub' 2>/dev/null | while read line; do echo "$line:$(awk '{print $NF}' $line)" ; done)
do
	break
done

mkdir -p ~/.local;
git config --file ~/.local/${NAMESPACE}.gitconfig core.sshCommand "ssh -i $(echo "${PUBKEY}" | awk -F: '{print $1}')"

echo "Updated ~/.local/${NAMESPACE}.gitconfig: SSH Identity set to ${PUBKEY}"